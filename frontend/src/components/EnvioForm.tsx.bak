import React, { useState } from 'react';
import axios from 'axios';
import { useForm } from 'react-hook-form';
import * as yup from 'yup';
import { yupResolver } from '@hookform/resolvers/yup';


// Durante desarrollo utilizar una ruta relativa para que Vite (o el proxy) redirija a la API.
// Esto evita que el frontend intente resolver hostnames `-8000.app.github.dev` directamente.
const API_BASE_URL = '/v1';
const AUTH_TOKEN = 'Bearer TEST_BEARER_TOKEN_2025';


type LogisticaType = 'Terrestre' | 'Maritimo';

interface FormFields {
    tipoLogistica: LogisticaType;
    cliente_id: number;
    tipo_producto_id: number;
    cantidad: number;
    fecha_registro: string;
    fecha_entrega: string;
    precio_envio: number;
    // Terrestre
    bodega_id?: number;
    placa_vehiculo?: string;
    // Mar√≠timo
    puerto_id?: number;
    num_flota?: string;
}


const baseSchema = {
    tipoLogistica: yup.string().required(),
    cliente_id: yup.number().required("ID Cliente es requerido").positive().integer(),
    tipo_producto_id: yup.number().required("ID Producto es requerido").positive().integer(),
    cantidad: yup.number().required("Cantidad es requerida").min(1, "M√≠nimo 1 unidad"),
    fecha_registro: yup.date().required("Fecha de Registro es requerida"),
    fecha_entrega: yup.date().required("Fecha de Entrega es requerida"),
    precio_envio: yup.number().required("Precio es requerido").positive("Debe ser positivo"),
};

// Terrestre
const terrestreSchema = yup.object().shape({
    ...baseSchema,
    bodega_id: yup.number().required("ID Bodega es requerido").positive().integer(),
    // Val AAA999
    placa_vehiculo: yup.string().required("Placa es requerida").matches(/^[A-Z]{3}\d{3}$/, "Formato: AAA999"), 
});

//  Mar√≠timo
const maritimoSchema = yup.object().shape({
    ...baseSchema,
    puerto_id: yup.number().required("ID Puerto es requerido").positive().integer(),
    // Val AAA9999A
    num_flota: yup.string().required("N√∫mero de Flota es requerido").matches(/^[A-Z]{3}\d{4}[A-Z]{1}$/, "Formato: AAA9999A"), 
});

interface EnvioFormProps {
    onSuccess: () => void; 
}

export const EnvioForm: React.FC<EnvioFormProps> = ({ onSuccess }) => {
    const [tipoLogistica, setTipoLogistica] = useState<LogisticaType>('Terrestre');
    const [message, setMessage] = useState('');
    const [loading, setLoading] = useState(false);

    // Selecciona el schema din√°micamente
    const currentSchema = tipoLogistica === 'Terrestre' ? terrestreSchema : maritimoSchema;

    const { register, handleSubmit, formState: { errors }, reset } = useForm<FormFields>({
        resolver: yupResolver(currentSchema) as any, 
        defaultValues: { tipoLogistica: 'Terrestre' }
    });

        // Convertir fechas a formato ISO date string (YYYY-MM-DD) sin hora
        const formatDate = (dateInput: string | Date): string => {
            const d = typeof dateInput === 'string' ? new Date(dateInput) : dateInput;
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

    const onSubmit = async (data: FormFields) => {
        setLoading(true);
        setMessage('');

        const endpoint = tipoLogistica === 'Terrestre' ? 'terrestre/envios' : 'maritimo/envios';
        
        const payload = {
            cliente_id: data.cliente_id,
            tipo_producto_id: data.tipo_producto_id,
            cantidad: data.cantidad,
            fecha_registro: formatDate(data.fecha_registro),
            fecha_entrega: formatDate(data.fecha_entrega),
            precio_envio: data.precio_envio,
            
            ...(tipoLogistica === 'Terrestre' ? { bodega_id: data.bodega_id, placa_vehiculo: data.placa_vehiculo } : {}),
            ...(tipoLogistica === 'Maritimo' ? { puerto_id: data.puerto_id, num_flota: data.num_flota } : {})
        };

        try {
            const response = await axios.post(`${API_BASE_URL}/${endpoint}`, payload, {
                headers: {
                    'Authorization': AUTH_TOKEN,
                    'Content-Type': 'application/json'
                }
            });

            setMessage(`‚úÖ Env√≠o ${tipoLogistica} registrado. Gu√≠a: ${response.data.num_guia}. Precio Final: $${response.data.precio_final.toFixed(2)}`);
            reset({ tipoLogistica: tipoLogistica }); 
            onSuccess(); 
        } catch (error: any) {
            console.error('Error al registrar env√≠o:', error);
            const detail = error.response?.data?.detail;
            if (Array.isArray(detail)) {
                
                setMessage(`‚ùå Error de validaci√≥n: ${detail[0]?.msg} en campo ${detail[0]?.loc[detail[0]?.loc.length - 1]}`);
            } else {
                 setMessage(`‚ùå Error al registrar: ${detail || 'Fallo de conexi√≥n o servidor no disponible.'}`);
            }
        } finally {
            setLoading(false);
        }
    };

    const handleLogisticaChange = (e: React.ChangeEvent<HTMLSelectElement>) => {
        const newLogistica = e.target.value as LogisticaType;
        setTipoLogistica(newLogistica);
        reset({ tipoLogistica: newLogistica }); 
    };

    return (
        <div className="envio-form-container">
            <h3>Registro de Env√≠os</h3>
            
            <label htmlFor="logistica-select">Tipo de Log√≠stica:</label>
            <select id="logistica-select" value={tipoLogistica} onChange={handleLogisticaChange} style={{ padding: '8px', marginBottom: '15px', width: '100%' }}>
                <option value="Terrestre">Log√≠stica Terrestre üöõ</option>
                <option value="Maritimo">Log√≠stica Mar√≠tima üö¢</option>
            </select>

            <form onSubmit={handleSubmit(onSubmit)}>
                {/* Campos Comunes */}
                <input {...register("cliente_id")} placeholder="ID Cliente (ej: 1)" type="number" />
                {errors.cliente_id && <p className="error">{errors.cliente_id.message}</p>}
                
                <input {...register("tipo_producto_id")} placeholder="ID Tipo Producto (ej: 1)" type="number" />
                {errors.tipo_producto_id && <p className="error">{errors.tipo_producto_id.message}</p>}
                
                <input {...register("cantidad")} placeholder="Cantidad de Producto" type="number" />
                {errors.cantidad && <p className="error">{errors.cantidad.message}</p>}
                
                <input {...register("precio_envio")} placeholder="Precio Base ($)" type="number" step="0.01" />
                {errors.precio_envio && <p className="error">{errors.precio_envio.message}</p>}
                
                <label>Fecha Registro:</label>
                <input {...register("fecha_registro")} type="date" defaultValue={new Date().toISOString().substring(0, 10)} />
                {errors.fecha_registro && <p className="error">{errors.fecha_registro.message}</p>}
                
                <label>Fecha Entrega:</label>
                <input {...register("fecha_entrega")} type="date" defaultValue={new Date(Date.now() + 86400000 * 7).toISOString().substring(0, 10)} />
                {errors.fecha_entrega && <p className="error">{errors.fecha_entrega.message}</p>}
                
                <hr style={{ margin: '15px 0' }} />

                {/* Campos Espec√≠ficos (Renderizado Condicional) */}
                <h4 style={{ color: tipoLogistica === 'Terrestre' ? 'green' : 'blue' }}>Detalles de Log√≠stica {tipoLogistica}</h4>

                {tipoLogistica === 'Terrestre' && (
                    <>
                        <input {...register("bodega_id")} placeholder="ID Bodega de Entrega" type="number" />
                        {errors.bodega_id && <p className="error">{errors.bodega_id.message}</p>}
                        
                        <input {...register("placa_vehiculo")} placeholder="Placa Veh√≠culo (AAA999)" />
                        {errors.placa_vehiculo && <p className="error">{errors.placa_vehiculo.message}</p>}
                    </>
                )}

                {tipoLogistica === 'Maritimo' && (
                    <>
                        <input {...register("puerto_id")} placeholder="ID Puerto de Entrega" type="number" />
                        {errors.puerto_id && <p className="error">{errors.puerto_id.message}</p>}
                        
                        <input {...register("num_flota")} placeholder="N√∫mero Flota (AAA9999A)" />
                        {errors.num_flota && <p className="error">{errors.num_flota.message}</p>}
                    </>
                )}

                <button type="submit" disabled={loading} style={{ marginTop: '20px' }}>
                    {loading ? 'Enviando...' : `Registrar Env√≠o ${tipoLogistica}`}
                </button>
            </form>
            
            {message && <div className={message.startsWith('‚úÖ') ? 'message-success' : 'message-error'}>{message}</div>}
        </div>
    );
};
